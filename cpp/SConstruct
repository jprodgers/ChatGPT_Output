import os
import sys

env = Environment()

godot_cpp_path = ARGUMENTS.get("godot_cpp_path", os.environ.get("GODOT_CPP_PATH", "godot-cpp"))
platform = ARGUMENTS.get("platform", env["PLATFORM"] if "PLATFORM" in env else sys.platform)
target = ARGUMENTS.get("target", "template_debug")
bits = ARGUMENTS.get("bits", "64")

if not os.path.isdir(godot_cpp_path):
    print("godot-cpp checkout not found. Set GODOT_CPP_PATH or pass godot_cpp_path=<path>.")
    Exit(1)

env.Append(CPPPATH=[
    os.path.join(godot_cpp_path, "include"),
    os.path.join(godot_cpp_path, "include", "gen"),
])
env.Append(CPPFLAGS=["-std=c++17", "-fPIC"])
env.Append(LIBPATH=[os.path.join(godot_cpp_path, "bin")])
env.Append(LIBS=[f"godot-cpp.{platform}.{target}.{bits}"])

sources = Glob("src/*.cpp")

lib_prefix = "lib" if not platform.startswith("win") else ""
lib_ext = ".dll" if platform.startswith("win") else (".dylib" if platform == "darwin" else ".so")
suffix = ".debug" if "debug" in target else ""

target_name = f"../bin/{lib_prefix}native_automata{suffix}{lib_ext}"

env.SharedLibrary(target=target_name, source=sources)
